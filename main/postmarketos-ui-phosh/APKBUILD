# Reference: https://postmarketos.org/uipkg
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=postmarketos-ui-phosh
pkgver=17
pkgrel=1
pkgdesc="(Wayland) Mobile UI developed for the Librem 5"
url="https://puri.sm"
arch="noarch !armhf"
license="GPL-3.0-or-later"
# !pipewire-pulse: prevent audio breakage, see pma#1386
depends="
	!pipewire-pulse
	bluez
	dnsmasq
	gnome-keyring
	iio-sensor-proxy
	iio-sensor-proxy-openrc
	modemmanager
	modemmanager-openrc
	networkmanager
	phosh
	polkit-elogind
	postmarketos-base-ui
	pulseaudio
	tinydm
	tinydm-openrc
	udiskie
	xdg-desktop-portal-gtk
	"
_pmb_recommends="
	calls
	chatty
	eog
	firefox-esr
	font-noto
	font-noto-emoji
	gedit
	gnome-calculator
	gnome-clocks
	gnome-contacts
	gnome-software
	kgx
	lollypop
	megapixels
	mobile-config-firefox
	portfolio
	postmarketos-artwork-wallpapers
	postmarketos-hidden-desktop-entries
	postmarketos-tweaks
	postmarketos-welcome-gtk3
	ttyescape
	xdg-user-dirs
	xwayland
	yelp
	"
_pmb_groups="feedbackd"
subpackages="$pkgname-qt_tweaks $pkgname-firefox"
install="$pkgname.post-install $pkgname.post-upgrade"
source="
	000-gschema.override
	01-phoc-scaling
	02-gnome-software-tweaks
	03-favorites
	dconf-profile-postmarketos
	firefox.desktop
	mimeapps.list
	osk.sh
	phosh-qt-mobile-controls.sh
	phosh-qt-wayland.sh
	udiskie.desktop
	"
options="!check pmb:gpu-accel"

package() {
	install -Dm644 "$srcdir"/000-gschema.override \
		"$pkgdir"/usr/share/glib-2.0/schemas/000-postmarketos.gschema.override
	install -Dm755 "$srcdir"/osk.sh \
		"$pkgdir"/usr/bin/osk-wayland
	install -Dm755 "$srcdir"/dconf-profile-postmarketos \
		"$pkgdir"/etc/dconf/profile/user
	install -Dm644 "$srcdir"/mimeapps.list \
		"$pkgdir"/usr/share/applications/mimeapps.list
	install -Dm755 "$srcdir"/01-phoc-scaling \
		"$pkgdir"/etc/dconf/db/postmarketos.d/01-phoc-scaling
	install -Dm755 "$srcdir"/02-gnome-software-tweaks \
		"$pkgdir"/etc/dconf/db/postmarketos.d/02-gnome-software-tweaks
	install -Dm755 "$srcdir"/03-favorites \
		"$pkgdir"/etc/dconf/db/postmarketos.d/03-favorites
	install -Dm644 "$srcdir"/udiskie.desktop \
		"$pkgdir"/etc/xdg/autostart/udiskie.desktop
}

qt_tweaks() {
	install_if="$pkgname=$pkgver-r$pkgrel qt5-qtbase"
	depends="qt5-qtwayland"
	install -Dm755 -t "$subpkgdir"/etc/profile.d/ \
		"$srcdir"/phosh-qt-mobile-controls.sh \
		"$srcdir"/phosh-qt-wayland.sh
}

firefox() {
	pkgdesc="Helper for phosh to display the icon"
	# mobile-config-firefox instead of ff or ff-esr, so it works with both
	install_if="$pkgname=$pkgver-r$pkgrel mobile-config-firefox"
	install -Dm644 -t "$subpkgdir"/usr/share/applications \
		"$srcdir"/firefox.desktop
}

sha512sums="
d321d2829da80a61a084b6b2e8ca7d9148fcf2bdf9b160213451de0f8be28aab5172377ba7e944653ddb8e3f6e7eee48efe143ee7045ea529ec33adc70fea6a0  000-gschema.override
4a60c08c86688f2d92820bc07305fe1bcff54986d29ee5dd84c7902ea5247b73b96f7453d2da9931a19903b2f5825b8a636f92edcf89bc205a7d389defea0b0e  01-phoc-scaling
50aa0083fc83f85e8c3e624c7782a5be01187321645c01d20c9f3adf19893375ab7d7b1ec3d51943fd09bcc78df4bbe1a369c951500bc7b766baff01febc1015  02-gnome-software-tweaks
b9fed11dfd51cb54f9523376c965a952c1785c369a8e747868609dcb14787f260d994cb8a60a033a0ad2aa0991eb985dff158850d0f6ff48410f5ae7b789fc36  03-favorites
e00756c2c056f68123d877f2f6a5ad3434ca7851095f021c26831c081728b821cf7947ba08d6742eee51d93dc83859a7ead553f4dcbc8b6fcefa33ae344ba178  dconf-profile-postmarketos
5a450658f94e5064ff233ec0dd1fcc42334d599b07bcc7cf281f73e593f5188c1a23cec0246f28bfb19c70fe4c29709dd4bdc72a7593b79ccaca9f34af37e3d6  firefox.desktop
253560b28bcb3d7908e07a7656bb1f5dab8d709c0a2e789c461d8d99dadb86f95203d6c66741197eaaa4c62eda52997736da618fc63ef1b9dcc79e4eaa635443  mimeapps.list
4113ef59267e88d205ef1e1aec0ed11ccf817a25c232f2006a538b56fb466fad5025ad445d109e367ca92ee98d9b25f1f9a1a4b9bae2cb80df12a3739d62d10a  osk.sh
bf8db527c49fa724e640a90269ba2648a2555f5867b2adbfbd88d1f685261f757339757c09ee08f590c76de4bd3d0c73a47dea9bd340644dd4707e76152cefd1  phosh-qt-mobile-controls.sh
6e193eca3961a78d47b4656892eae34d019d9317a255a201f5ea61e3300caff04c526a27cd98d0edc072b36e3eaf3a1768f4cd27c5e2be8b19c167d535c820a6  phosh-qt-wayland.sh
53f5c565b4ca8a12f12b63ec84a0194ef530703565d123203d41582a35a54d66afaf3a676df158ae0effe327dcfc1c6496a082ce9dbe803b2547417c3c3fad6e  udiskie.desktop
"
